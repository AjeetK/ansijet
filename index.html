<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Ansibot by hiddentao</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Ansibot</h1>
        <p class="header">Ansible playbook automation server</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/hiddentao/ansijet/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/hiddentao/ansijet/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/hiddentao/ansijet">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/hiddentao">hiddentao</a></p>


      </header>
      <section>
        <h1>
<a name="ansijet" class="anchor" href="#ansijet"><span class="octicon octicon-link"></span></a>Ansijet</h1>

<p><a href="http://travis-ci.org/hiddentao/ansijet"><img src="https://secure.travis-ci.org/hiddentao/ansijet.png" alt="Build Status"></a></p>

<p>An <a href="http://ansible.com/">Ansible</a> playbook automation server.</p>

<p>A node.js server which exposes a simple web API which triggers playbook runs 
when a request is received. This is especially useful if you are unable to run 
Ansible playbooks directly from within your continuous integration environment 
or if you simply wish to trigger playbook runs based on other 
events within your system.</p>

<p>Features:</p>

<ul>
<li>Trigger playbook runs from <a href="#triggers">different sources</a>, including from Continous Integration systems such as <a href="https://www.shippable.com">Shippable</a>.</li>
<li>Runs multile playbooks simultaneously, all in separate shell processes</li>
<li>Fast, friendly web interface with accompanying <a href="#rest-api">REST API</a>
</li>
<li>Highly asynchronous, scalable back-end</li>
<li>Full console <a href="#execution-logs">log capture</a> and storage</li>
</ul><h2>
<a name="installation-and-startup" class="anchor" href="#installation-and-startup"><span class="octicon octicon-link"></span></a>Installation and startup</h2>

<p><strong>Pre-requisite: Ansible 1.5+</strong></p>

<p>Installation instructions: <a href="http://docs.ansible.com/intro_installation.html">http://docs.ansible.com/intro_installation.html</a>.</p>

<p>To ensure you have the latest version it is recommended that you install it 
using <code>pip</code>, the Python package manager.</p>

<p><strong>Pre-requisite: Node.js 0.11.2+</strong></p>

<p>Installation instructions: <a href="http://nodejs.org/">http://nodejs.org/</a>. </p>

<p>Ensure the installed version is at least <strong>0.11.2</strong>. Ansijet will not work with 
earlier versions.</p>

<p><em>(For Ubuntu users I recommend the <a href="https://launchpad.net/%7Echris-lea/+archive/node.js/">Chris Lea PPA</a>)</em>.</p>

<p><strong>Pre-requisite: MongoDB</strong></p>

<p>Installation instructions: </p>

<p>Ansible stores its data in MongoDB. The default configuration expects to be able 
to connect to a MongoDB server running on <code>127.0.0.1</code> (i.e. <code>localhost</code>).</p>

<p><strong>Setup your Ansible playbooks</strong></p>

<p>Place your Ansible playbooks somewhere, e.g. <code>/playbooks</code>.</p>

<p>Ansijet expects your playbooks folder to have a certain structure:</p>

<pre><code>&lt;playbooks folder&gt;/*.yml   &lt;- your playbooks
&lt;playbooks folder&gt;/hosts   &lt;- Ansible hosts file
</code></pre>

<p>Ensure that any <a href="http://docs.ansible.com/playbooks_roles.html"><code>roles</code></a> needed 
by your playbooks can be found by the 
<code>ansible-playbook</code> binary. An easy way to ensure this is to store your roles 
within the same folder, i.e. at <code>&lt;playbooks folder&gt;/roles/</code>. Ditto for 
<code>group_vars</code> and <code>host_vars</code> folders.</p>

<p><strong>Setup Ansijet</strong></p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>git clone https://github.com/hiddentao/ansijet.git ansijet
<span class="nv">$ </span><span class="nb">cd </span>ansijet
<span class="nv">$ </span>npm install -g gulp bower
<span class="nv">$ </span>npm install
<span class="nv">$ </span>bower install
<span class="nv">$ </span>npm run build
</pre></div>

<p>Now create <code>ansijet/src/config/production.js</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/** Path to folder containg Ansible playbooks */</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">ansiblePlaybooks</span> <span class="o">=</span> <span class="s1">'/playbooks'</span>

  <span class="cm">/** Max no. of jobs to execute in parallel. Should match no. of CPU cores. */</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">jobsInParallel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>If you look inside <code>ansijet/src/config/base.js</code> you will see other 
configuration settings MongoDB, logging, etc. You may 
override these too within the <code>config/production.js</code> you created.</p>

<p><strong>Run Ansijet</strong></p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span><span class="nb">cd </span>ansijet
<span class="nv">$ NODE_ENV</span><span class="o">=</span>production ./start-app.js
</pre></div>

<p>If you visit <code>http://localhost:3000</code> you should see the dashboard showing the 
<em>Active Jobs</em> (there should be none currently).</p>

<h2>
<a name="setup-playbook-automation" class="anchor" href="#setup-playbook-automation"><span class="octicon octicon-link"></span></a>Setup playbook automation</h2>

<p>Once Ansijet is up and running and you can access the web interface you can view 
the list of Playbooks that Ansijet has found and assign triggers to them.</p>

<h3>
<a name="triggers" class="anchor" href="#triggers"><span class="octicon octicon-link"></span></a>Triggers</h3>

<p>A trigger is a mechanism which kicks of a playook run when an incoming URL 
request is received. </p>

<p>Triggers have two purposes:</p>

<ol>
<li>To perform any necessary additional checks when a request is received to 
ensure that the request is valid</li>
<li>To supply variables to the Ansible playbook, allowing for playbook execution 
to be configurable based on the incoming request and the trigger configuration.</li>
</ol><p>All triggers URLs look like <code>/invoke/&lt;trigger id&gt;?token=&lt;secret token&gt;</code> with 
additional query parameters depending on the trigger type.</p>

<p><em>Note: The <code>&lt;secret token&gt;</code> is randomly generated by Ansijet when a trigger is created 
and acts as an additional security check. If the token in an incoming request is 
incorrect Ansijet does not report this to the URL requester - it simply logs 
this fact in the back-end.</em></p>

<p>At present two trigger types are supported:</p>

<p><strong>Trigger: Simple</strong></p>

<p>This exposes a simple URL which triggers a playbook run. It does not 
perform any checks prior to triggering the playbook run. Neither does it supply 
any Ansible playbook variables.</p>

<p><strong>Trigger: Shippable</strong></p>

<p>This exposes a URL to be called after a successful <a href="shippable.com">shippable.com</a> 
CI build. It can be configured with a Shippable project id and a Git branch 
to execute playbook runs for. It supplies the following Ansible variables:</p>

<ul>
<li>
<code>shippable_project_id</code>        &lt;- configured by user</li>
<li>
<code>shippable_expected_branch</code>   &lt;- configured by user</li>
<li>
<code>shippable_build_num</code>         &lt;- obtained from incoming request</li>
<li>
<code>shippable_build_branch</code>      &lt;- obtained from incoming request</li>
</ul><p><em>(Future improvement: once <a href="https://github.com/hiddentao/ansijet/issues/2">Shippable build artefacts</a> 
are publicly accessible Ansijet will be able to supply the build artefacts URL 
to playbooks).</em></p>

<h3>
<a name="jobs" class="anchor" href="#jobs"><span class="octicon octicon-link"></span></a>Jobs</h3>

<p>When a trigger is invoked it runs a playbook, known as a <em>Job</em>. Jobs are 
executed in parallel by 
Ansijet, with the maximum no. of simultaenous jobs determined by the 
<code>jobsInParallel</code> configuration parameter set during Ansijet installation. 
Ansijet is also smart enough to ensure that for each playbook, only one instance 
of it is being run at a time.</p>

<p>Each job - i.e. playbook run - takes place in a separate shell process, allowing 
Ansijet to be scaled up according to your machine's cores. Ansijet also 
monitors each shell process such that if no output is received for 5 minutes 
(this time window is configurable) it will kill the shell process 
and assume the playbook run has failed.</p>

<p>When a job is being processed it shows up as an <em>Active Job</em> on your Ansijet 
server's homepage. You can click on it to view the current log output, including 
console log output.</p>

<h3>
<a name="execution-logs" class="anchor" href="#execution-logs"><span class="octicon octicon-link"></span></a>Execution logs</h3>

<p>All logs can be viewed by going to the <em>Logs</em> site section. You can then drill 
down to view the logs pertaining to a particular trigger and/or a particular 
trigger job.</p>

<h2>
<a name="rest-api" class="anchor" href="#rest-api"><span class="octicon octicon-link"></span></a>REST API</h2>

<p>Ansijet is built using <a href="http://waigojs.com">Waigo</a>, which means that all the 
URL routes automatically have REST API counterparts. For any given URL, you can 
view REST JSON output by simply appending a <code>format=json</code> query parameter when 
making the request. This applies to form submissions too. For more information 
on this <a href="http://waigojs.com/guide.html#views-and-output-formats">see the Waigo docs</a>.</p>

<h2>
<a name="securing-ansijet" class="anchor" href="#securing-ansijet"><span class="octicon octicon-link"></span></a>Securing Ansijet</h2>

<p>Ansijet does not come with any sort of authentication out of the box. Since it's 
running playbooks which most probably affect your servers you will likely want to 
protect access to it.</p>

<p>My setup is to have Ansijet placed behind an Nginx front-end 
server, with SSL and HTTP Basic auth enforced on all incoming requests:</p>

<pre><code>server {
  listen 80;
  server_name example.com www.example.com;
  return 301 https://$host$request_uri;
}

server {
  listen 443;
  server_name example.com www.example.com;

  ssl on;
  ssl_certificate /etc/ssl/certs/server.crt;
  ssl_certificate_key /etc/ssl/private/server.key;
  ssl_session_timeout 5m;

  # Perfect Forward Secrecy
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_ciphers EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA256:EECDH+aRSA+RC4:EDH+aRSA:EECDH:RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS;

  root /ansijet/frontend/build;

  location ~ /\. {
    deny all;
  }

  location ~* ^/(css|fonts|img|js)/.+$ {
    gzip_static on;
    gzip_vary on;
    expires 30d;
    add_header Pragma public;
    add_header Cache-Control "public";
  }

  location ~* ^(robots|humans)\.txt$ {
    expires 30d;
    add_header Pragma public;
    add_header Cache-Control "public";
  }

  # If you want to monitor the status of Ansijet and check that it is running 
  # you can call the `/ping` URL. This will output `Ansijet up` is Ansijet is 
  # running
  location = /ping {
    proxy_pass http://127.0.0.1:3000;
  }

  # Everything else needs auth
  location / {
    auth_basic on;
    auth_basic_user_file /ansijet/httpd.auth;
    proxy_pass http://127.0.0.1:3000;
  }

}
</code></pre>

<h2>
<a name="contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>Though I am already using Ansijet in a production environment it is very much a 
work-in-progress. All suggestions and pull requests are welcome! </p>

<p>See CONTRIBUTING.md for guidelines.</p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>MIT - see LICENSE.md</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
